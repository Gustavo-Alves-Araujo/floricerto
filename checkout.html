<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - La Floricultura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600&family=Inter:wght@300;400&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bege': '#E8E3D8',
                        'bege-dark': '#D4CEC0',
                        'text-dark': '#2D2D2D',
                        'text-light': '#707070'
                    },
                    fontFamily: {
                        'serif': ['"Crimson Text"', 'serif'],
                        'sans': ['"Inter"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-feature-settings: "pnum";
            line-height: 1.6;
        }
        
        /* Logo redonda com crop central */
        .logo-circular {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            object-position: center center;
            overflow: hidden;
        }
        input, textarea, select {
            background-color: transparent !important;
            border-bottom: 2px solid rgba(45, 45, 45, 0.15);
            transition: all 0.3s ease;
            padding: 0.75rem 0;
        }
        input:focus, textarea:focus, select:focus {
            border-bottom-color: #2D2D2D;
            outline: none;
        }
        input[readonly] {
            background-color: rgba(45, 45, 45, 0.05) !important;
        }
        label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }
        .section { display: none; }
        .section.active { display: block; }
        .step-inactive { opacity: 0.5; }
        .error { color: #dc2626; font-size: 0.875rem; margin-top: 0.5rem; }
        .success { color: #16a34a; font-size: 0.875rem; margin-top: 0.5rem; }
        
        /* Anima√ß√£o de pulso para o bot√£o WhatsApp */
        @keyframes pulse-whatsapp {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .whatsapp-button {
            animation: pulse-whatsapp 2s ease-in-out infinite;
        }
        
        .whatsapp-button:hover {
            animation: none;
        }
    </style>
</head>
<body class="bg-bege text-text-dark font-serif antialiased selection:bg-text-dark selection:text-white relative">

    <!-- Header Simplificado -->
    <header class="fixed w-full top-0 bg-bege/98 backdrop-blur-sm z-40 border-b border-text-dark/10 shadow-sm">
        <nav class="container mx-auto px-4 md:px-6 py-3 md:py-4 flex flex-wrap items-center gap-3 md:gap-4">
            <!-- Logo -->
            <a href="index.html" class="flex-shrink-0">
                <img src="img/LOGO - SITE.png" alt="La Floricultura" class="logo-circular">
            </a>
            
            <!-- Links e Carrinho -->
            <div class="flex items-center gap-2 md:gap-4 flex-shrink-0 ml-auto">
                <a href="index.html#produtos" class="hidden lg:block font-sans text-xs md:text-sm text-text-dark hover:text-text-dark/60 transition-colors">
                    Produtos
                </a>
                <a href="admin.html" class="hidden lg:block font-sans text-xs md:text-sm text-text-dark hover:text-text-dark/60 transition-colors">
                    Admin
                </a>
                <a href="carrinho.html" class="flex items-center gap-2 md:gap-3 bg-text-dark text-bege px-4 md:px-6 py-2 md:py-3 rounded-full hover:bg-text-dark/90 transition-all shadow-md hover:shadow-lg">
                    <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                    <span class="hidden md:inline font-sans text-xs md:text-sm font-medium">Carrinho</span>
                    <span class="cart-count bg-bege text-text-dark w-5 h-5 md:w-6 md:h-6 rounded-full flex items-center justify-center text-[10px] md:text-xs font-bold">0</span>
                </a>
            </div>
        </nav>
    </header>

    <!-- Checkout Section -->
    <section class="container mx-auto px-6 pt-32 pb-16 min-h-screen">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-5xl md:text-6xl font-light mb-4 text-center">Finalizar Pedido</h1>
            <p class="text-center text-text-light font-sans mb-12">Preencha seus dados para concluir a compra</p>
        
            <!-- Steps -->
            <div class="flex gap-4 mb-12">
                <div class="flex-1 text-center">
                    <div class="inline-block w-10 h-10 rounded-full bg-text-dark text-bege flex items-center justify-center font-bold step-1">1</div>
                    <p class="text-sm mt-2 step-1-label font-sans">Endere√ßo</p>
                </div>
                <div class="flex-1 text-center">
                    <div class="inline-block w-10 h-10 rounded-full bg-text-dark/20 text-text-dark flex items-center justify-center font-bold step-2 step-inactive">2</div>
                    <p class="text-sm mt-2 step-2-label font-sans">Dados Pessoais</p>
                </div>
                <div class="flex-1 text-center">
                    <div class="inline-block w-10 h-10 rounded-full bg-text-dark/20 text-text-dark flex items-center justify-center font-bold step-3 step-inactive">3</div>
                    <p class="text-sm mt-2 step-3-label font-sans">Entrega</p>
                </div>
                <div class="flex-1 text-center">
                    <div class="inline-block w-10 h-10 rounded-full bg-text-dark/20 text-text-dark flex items-center justify-center font-bold step-4 step-inactive">4</div>
                    <p class="text-sm mt-2 step-4-label font-sans">Confirma√ß√£o</p>
                </div>
            </div>

            <!-- STEP 1: Endere√ßo -->
            <section id="step-endereco" class="section active">
                <div class="bg-white/50 p-8 rounded-2xl shadow-md border border-text-dark/10">
                    <h2 class="font-sans text-lg tracking-wide uppercase text-text-dark mb-6 pb-4 border-b-2 border-text-dark/10">Endere√ßo de Entrega</h2>
                    
                    <div class="mb-6">
                        <label class="text-text-dark/70 font-sans">CEP *</label>
                        <div class="flex gap-4">
                            <input type="text" id="cep" placeholder="00000-000" maxlength="9" class="flex-1" required>
                            <button type="button" onclick="buscarCEP()" class="bg-text-dark/10 hover:bg-text-dark/20 text-text-dark px-6 py-3 rounded-lg text-sm tracking-wide transition-colors duration-300 font-sans">
                                Buscar
                            </button>
                        </div>
                        <div id="cep-error" class="error"></div>
                        <div id="cep-success" class="success"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 font-sans text-base mb-6">
                        <div>
                            <label class="text-text-dark/70">Rua *</label>
                            <input type="text" id="rua" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="text-text-dark/70">N√∫mero *</label>
                            <input type="text" id="numero" class="w-full" required>
                        </div>
                        <div>
                            <label class="text-text-dark/70">Bairro *</label>
                            <input type="text" id="bairro" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="text-text-dark/70">Cidade *</label>
                            <input type="text" id="cidade" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="text-text-dark/70">Estado *</label>
                            <input type="text" id="estado" class="w-full" readonly>
                        </div>
                        <div>
                            <label class="text-text-dark/70">Complemento (opcional)</label>
                            <input type="text" id="complemento" class="w-full" placeholder="Apto 123, sala, etc">
                        </div>
                    </div>

                    <button type="button" onclick="proximaStep(2)" class="w-full bg-text-dark text-bege py-4 text-center font-sans text-sm tracking-widest uppercase hover:bg-text-dark/90 transition-all duration-300 rounded-lg shadow-md hover:shadow-xl">
                        Pr√≥ximo
                    </button>
                </div>
            </section>

            <!-- STEP 2: Dados Pessoais -->
            <section id="step-pessoal" class="section">
                <div class="bg-white/50 p-8 rounded-2xl shadow-md border border-text-dark/10">
                    <h2 class="font-sans text-lg tracking-wide uppercase text-text-dark mb-6 pb-4 border-b-2 border-text-dark/10">Dados Pessoais</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 font-sans text-base mb-6">
                        <div>
                            <label class="text-text-dark/70">Nome Completo *</label>
                            <input type="text" id="nome_cliente" class="w-full" required>
                        </div>
                        <div>
                            <label class="text-text-dark/70">Telefone *</label>
                            <input type="tel" id="telefone" placeholder="(21) 99267-4996" class="w-full" required>
                        </div>
                        <div>
                            <label class="text-text-dark/70">CPF *</label>
                            <input type="text" id="cpf" placeholder="000.000.000-00" class="w-full" required>
                        </div>
                        <div>
                            <label class="text-text-dark/70">Quem vai Receber? *</label>
                            <input type="text" id="nome_recebedor" placeholder="Nome da pessoa" class="w-full" required>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="proximaStep(1)" class="flex-1 bg-text-dark/20 text-text-dark py-4 text-center font-sans text-sm tracking-widest uppercase hover:bg-text-dark/30 transition-all duration-300 rounded-lg">
                            Voltar
                        </button>
                        <button type="button" onclick="proximaStep(3)" class="flex-1 bg-text-dark text-bege py-4 text-center font-sans text-sm tracking-widest uppercase hover:bg-text-dark/90 transition-all duration-300 rounded-lg shadow-md hover:shadow-xl">
                            Pr√≥ximo
                        </button>
                    </div>
                </div>
            </section>

            <!-- STEP 3: Entrega -->
            <section id="step-entrega" class="section">
                <div class="bg-white/50 p-8 rounded-2xl shadow-md border border-text-dark/10">
                    <h2 class="font-sans text-lg tracking-wide uppercase text-text-dark mb-6 pb-4 border-b-2 border-text-dark/10">Op√ß√µes de Entrega</h2>
                    
                    <div class="grid grid-cols-1 gap-6 font-sans text-base mb-6">
                        <div>
                            <label class="text-text-dark/70">Data de Entrega *</label>
                            <input type="date" id="data_entrega" class="w-full" required>
                            <p class="text-xs text-text-dark/50 mt-2">Entrega dispon√≠vel para o mesmo dia se o cliente finalizar o pedido at√© √†s 17h.</p>
                        </div>

                        <div>
                            <label class="text-text-dark/70">Tipo de Entrega *</label>
                            <div id="opcoes-entrega" class="space-y-3">
                                <!-- Op√ß√µes ser√£o preenchidas via JavaScript -->
                            </div>
                            <div id="entrega-erro" class="error mt-2"></div>
                        </div>

                        <div>
                            <label class="text-text-dark/70">Instru√ß√µes Adicionais (opcional)</label>
                            <textarea id="instrucoes_adicionais" rows="3" class="w-full resize-none" placeholder="Ex: deixe na portaria, avise antes, etc"></textarea>
                        </div>

                        <div>
                            <label class="text-text-dark/70">Mensagem no Cart√£o (opcional)</label>
                            <textarea id="mensagem_cartao" rows="3" class="w-full resize-none" placeholder="Escreva sua mensagem personalizada para o cart√£o..."></textarea>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="proximaStep(2)" class="flex-1 bg-text-dark/20 text-text-dark py-4 text-center font-sans text-sm tracking-widest uppercase hover:bg-text-dark/30 transition-all duration-300 rounded-lg">
                            Voltar
                        </button>
                        <button type="button" onclick="proximaStep(4)" class="flex-1 bg-text-dark text-bege py-4 text-center font-sans text-sm tracking-widest uppercase hover:bg-text-dark/90 transition-all duration-300 rounded-lg shadow-md hover:shadow-xl">
                            Pr√≥ximo
                        </button>
                    </div>
                </div>
            </section>

            <!-- STEP 4: Confirma√ß√£o -->
            <section id="step-confirmacao" class="section">
                <div class="bg-white/50 p-8 rounded-2xl shadow-md border border-text-dark/10">
                    <h2 class="font-sans text-lg tracking-wide uppercase text-text-dark mb-6 pb-4 border-b-2 border-text-dark/10">Confirma√ß√£o do Pedido</h2>
                    
                    <!-- Resumo Endere√ßo -->
                    <div class="mb-6 pb-6 border-b border-text-dark/10">
                        <h3 class="font-serif text-lg font-semibold mb-2">Endere√ßo</h3>
                        <p id="resumo-endereco" class="text-sm text-text-dark/70 font-sans"></p>
                    </div>

                    <!-- Resumo Pessoal -->
                    <div class="mb-6 pb-6 border-b border-text-dark/10">
                        <h3 class="font-serif text-lg font-semibold mb-2">Dados Pessoais</h3>
                        <p id="resumo-pessoal" class="text-sm text-text-dark/70 font-sans"></p>
                    </div>

                    <!-- Resumo Entrega -->
                    <div class="mb-6 pb-6 border-b border-text-dark/10">
                        <h3 class="font-serif text-lg font-semibold mb-2">Entrega</h3>
                        <p id="resumo-entrega" class="text-sm text-text-dark/70 font-sans"></p>
                    </div>

                    <!-- Resumo Carrinho -->
                    <div class="mb-6 pb-6 border-b border-text-dark/10">
                        <h3 class="font-serif text-lg font-semibold mb-2">Produtos</h3>
                        <div id="resumo-carrinho" class="text-sm text-text-dark/70 font-sans"></div>
                    </div>

                    <!-- Total -->
                    <div class="mb-6 text-right" id="total-container">
                        <p class="font-serif text-2xl font-semibold">Total: <span id="total-valor">R$ 0,00</span></p>
                    </div>

                    <div id="confirmacao-erro" class="error mb-4"></div>

                    <div class="flex gap-4">
                        <button type="button" onclick="proximaStep(3)" class="flex-1 bg-text-dark/20 text-text-dark py-4 text-center font-sans text-sm tracking-widest uppercase hover:bg-text-dark/30 transition-all duration-300 rounded-lg">
                            Voltar
                        </button>
                        <button type="button" onclick="confirmarPedido()" class="flex-1 bg-text-dark text-bege py-4 text-center font-sans text-sm tracking-widest uppercase hover:bg-text-dark/90 transition-all duration-300 rounded-lg shadow-md hover:shadow-xl">
                            Confirmar e Pagar
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </section>

    <!-- Bot√£o WhatsApp Flutuante -->
    <a href="https://wa.me/5521992674996?text=Ol√°!%20Gostaria%20de%20saber%20mais%20sobre%20os%20produtos%20da%20La%20Floricultura" 
       target="_blank" 
       class="whatsapp-button fixed bottom-6 right-6 z-50 bg-[#25D366] text-white p-4 rounded-full shadow-2xl hover:bg-[#20BA5A] transition-all duration-300 hover:scale-110 group">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.98 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
        </svg>
        <span class="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-[#25D366] text-white px-3 py-2 rounded-lg text-sm font-sans whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
            Fale conosco
        </span>
    </a>

    <!-- Footer -->
    <footer class="bg-text-dark pt-16 pb-10 border-t border-text-dark mt-20">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-12 mb-12">
                <div>
                    <h3 class="text-2xl font-light mb-4 text-bege">La Floricultura</h3>
                    <p class="font-sans text-sm text-bege/60">
                        Design bot√¢nico desde 2026.
                    </p>
                </div>
                
                <div>
                    <h4 class="font-sans text-xs tracking-widest uppercase mb-4 text-bege/60">Navega√ß√£o</h4>
                    <ul class="space-y-2 font-sans text-sm text-bege/80">
                        <li><a href="index.html" class="hover:text-bege transition-colors">In√≠cio</a></li>
                        <li><a href="index.html#produtos" class="hover:text-bege transition-colors">Produtos</a></li>
                        <li><a href="carrinho.html" class="hover:text-bege transition-colors">Carrinho</a></li>
                        <li><a href="admin.html" class="hover:text-bege transition-colors">Admin</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="font-sans text-xs tracking-widest uppercase mb-4 text-bege/60">Pol√≠ticas</h4>
                    <ul class="space-y-2 font-sans text-sm text-bege/80">
                        <li><a href="politica-troca-devolucoes.html" class="hover:text-bege transition-colors">Pol√≠tica de Troca e Devolu√ß√µes</a></li>
                        <li><a href="politica-privacidade.html" class="hover:text-bege transition-colors">Pol√≠tica de Privacidade</a></li>
                        <li><a href="politica-envio-reembolso.html" class="hover:text-bege transition-colors">Pol√≠tica de Envio e Reembolso</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="font-sans text-xs tracking-widest uppercase mb-4 text-bege/60">Contato</h4>
                    <ul class="space-y-2 font-sans text-sm text-bege/80">
                        <li>contato@lafloricultura.com</li>
                        <li>(21) 99267-4996</li>
                        <li class="pt-2 text-xs">Seg ‚Äî S√°b: 9h √†s 19h</li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-bege/10 pt-6 text-center text-xs font-sans text-bege/40 uppercase tracking-wider">
                <p>&copy; 2026 La Floricultura. Rio de Janeiro.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Inicializar Supabase
        const supabaseClient = window.supabase.createClient(
            'https://nrgwldtmucptrhoyqted.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yZ3dsZHRtdWNwdHJob3lxdGVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTkxMjAsImV4cCI6MjA4NTkzNTEyMH0.8PLX18bXir94kCS5epFEyFGGEHxwKC3YANvwLE1SjmI'
        );
        
        window.supabaseDB = {
            getAllProducts: async () => {
                const { data, error } = await supabaseClient.from('produtos').select('*').order('id');
                if (error) throw error;
                return data || [];
            }
        };
    </script>
    <script src="js/produtos.js"></script>
    <script src="js/cart.js"></script>
    <script>
        // Cidades atendidas
        const CIDADES_ATENDIDAS = [
            { cidade: 'Rio de Janeiro', estado: 'RJ' },
            { cidade: 'Niter√≥i', estado: 'RJ' },
            { cidade: 'Icara√≠', estado: 'RJ' },
            { cidade: 'S√£o Gon√ßalo', estado: 'RJ' },
            { cidade: 'Duque de Caxias', estado: 'RJ' }
        ];

        async function buscarCEP() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            const errorDiv = document.getElementById('cep-error');
            const successDiv = document.getElementById('cep-success');

            console.log('üîç Buscando CEP:', cep);

            errorDiv.textContent = '';
            successDiv.textContent = '';

            if (cep.length !== 8) {
                errorDiv.textContent = '‚ùå CEP deve ter 8 d√≠gitos';
                console.log('‚ùå CEP inv√°lido - menos de 8 d√≠gitos');
                return;
            }

            // Buscar dados via ViaCEP
            try {
                console.log('üåê Consultando ViaCEP...');
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();

                console.log('üì¶ Resposta ViaCEP:', data);

                if (data.erro) {
                    errorDiv.textContent = '‚ùå CEP n√£o encontrado';
                    console.log('‚ùå ViaCEP retornou erro');
                    return;
                }

                // Validar se a cidade est√° na lista de cidades atendidas
                const cidadeEncontrada = CIDADES_ATENDIDAS.find(
                    cidade => cidade.cidade.toLowerCase() === data.localidade.toLowerCase() && 
                             cidade.estado === data.uf
                );

                if (!cidadeEncontrada) {
                    errorDiv.textContent = `‚ùå N√£o atendemos na cidade de ${data.localidade} - ${data.uf} ainda. Atendemos apenas: Rio de Janeiro, Niter√≥i, Icara√≠, S√£o Gon√ßalo e Duque de Caxias.`;
                    console.log('‚ùå Cidade fora da √°rea de entrega:', data.localidade, data.uf);
                    return;
                }

                // Preencher campos com dados da API
                document.getElementById('rua').value = data.logradouro || '';
                document.getElementById('bairro').value = data.bairro || '';
                document.getElementById('cidade').value = data.localidade;
                document.getElementById('estado').value = data.uf;

                successDiv.textContent = '‚úÖ Endere√ßo validado! Voc√™ est√° na regi√£o de entrega';
                console.log('‚úÖ Endere√ßo preenchido com sucesso!');
            } catch (error) {
                errorDiv.textContent = '‚ùå Erro ao buscar CEP. Tente novamente.';
                console.error('‚ùå Erro na busca:', error);
            }
        }

        // Navega√ß√£o entre steps
        function proximaStep(numeroStep) {
            // Validar step anterior
            if (numeroStep === 2 && !validarStep1()) return;
            if (numeroStep === 3 && !validarStep2()) return;
            if (numeroStep === 4 && !validarStep3()) return;

            // Esconder todos
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Mostrar novo
            const stepMap = { 1: 'endereco', 2: 'pessoal', 3: 'entrega', 4: 'confirmacao' };
            document.getElementById(`step-${stepMap[numeroStep]}`).classList.add('active');

            // Atualizar steps visuais
            for (let i = 1; i <= 4; i++) {
                const step = document.querySelector(`.step-${i}`);
                if (i < numeroStep) {
                    step.classList.remove('step-inactive');
                    step.style.backgroundColor = '#2D2D2D';
                    step.style.color = '#E8E3D8';
                    step.parentElement.style.opacity = '0.7';
                } else if (i === numeroStep) {
                    step.classList.remove('step-inactive');
                    step.style.backgroundColor = '#2D2D2D';
                    step.style.color = '#E8E3D8';
                    step.parentElement.style.opacity = '1';
                } else {
                    step.classList.add('step-inactive');
                    step.style.backgroundColor = 'rgba(45, 45, 45, 0.2)';
                    step.style.color = '#2D2D2D';
                }
            }

            // Se chegou ao passo 4, atualizar resumo
            if (numeroStep === 4) {
                atualizarResumo();
            }

            window.scrollTo(0, 0);
        }

        function validarStep1() {
            const cep = document.getElementById('cep').value;
            const rua = document.getElementById('rua').value;
            const numero = document.getElementById('numero').value;
            const bairro = document.getElementById('bairro').value;
            const cidade = document.getElementById('cidade').value;

            if (!cep || !rua || !numero || !bairro || !cidade) {
                alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios');
                return false;
            }
            return true;
        }

        function validarStep2() {
            const nome = document.getElementById('nome_cliente').value;
            const telefone = document.getElementById('telefone').value;
            const cpf = document.getElementById('cpf').value;
            const recebedor = document.getElementById('nome_recebedor').value;

            if (!nome || !telefone || !cpf || !recebedor) {
                alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios');
                return false;
            }
            return true;
        }

        function validarStep3() {
            const data = document.getElementById('data_entrega').value;
            const tipoEntrega = document.querySelector('input[name="tipo_entrega"]:checked');

            if (!data) {
                alert('‚ö†Ô∏è Selecione a data de entrega');
                return false;
            }

            // Validar se a data n√£o √© no passado
            // Criar datas no formato local para evitar problemas de timezone
            const hoje = new Date();
            const hojeLocal = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            
            // Converter data do input (YYYY-MM-DD) para Date local
            const [ano, mes, dia] = data.split('-').map(Number);
            const dataSelecionada = new Date(ano, mes - 1, dia);

            // Comparar apenas as datas (sem hora)
            if (dataSelecionada < hojeLocal) {
                alert('‚ö†Ô∏è A data de entrega n√£o pode ser anterior a hoje');
                return false;
            }

            // Validar entrega no mesmo dia (s√≥ permitir se for antes das 17h)
            const agora = new Date();
            const horaAtual = agora.getHours();
            const isHoje = dataSelecionada.getTime() === hojeLocal.getTime();
            
            if (isHoje && horaAtual >= 17) {
                alert('‚ö†Ô∏è Entrega no mesmo dia dispon√≠vel apenas at√© √†s 17h. Selecione uma data futura.');
                return false;
            }

            if (!tipoEntrega) {
                document.getElementById('entrega-erro').textContent = '‚ö†Ô∏è Selecione um tipo de entrega';
                return false;
            }

            // Validar per√≠odo manh√£ (s√≥ pode comprar at√© 10h do dia da entrega)
            if (tipoEntrega.value === 'manha' && isHoje && horaAtual >= 10) {
                alert('‚ö†Ô∏è Per√≠odo Manh√£ dispon√≠vel apenas at√© 10h do dia da entrega. Selecione outro per√≠odo ou outra data.');
                return false;
            }

            document.getElementById('entrega-erro').textContent = '';
            return true;
        }

        function calcularValorEntrega() {
            const tipoEntrega = document.querySelector('input[name="tipo_entrega"]:checked');
            if (!tipoEntrega) return 0;
            
            const valores = {
                'comercial': 0,
                'manha': 22.90,
                'tarde': 22.90,
                'expressa': 36.90
            };
            
            return valores[tipoEntrega.value] || 0;
        }

        function atualizarOpcoesEntrega() {
            const dataEntrega = document.getElementById('data_entrega').value;
            
            // Criar data de hoje no formato local
            const hoje = new Date();
            const hojeLocal = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            
            let isHoje = false;
            let horaAtual = new Date().getHours();
            
            if (dataEntrega) {
                // Converter data do input (YYYY-MM-DD) para Date local
                const [ano, mes, dia] = dataEntrega.split('-').map(Number);
                const dataSelecionada = new Date(ano, mes - 1, dia);
                
                isHoje = dataSelecionada.getTime() === hojeLocal.getTime();
                console.log('üìÖ Data selecionada:', dataEntrega, '√â hoje?', isHoje, 'Hora atual:', horaAtual);
            } else {
                console.log('üìÖ Nenhuma data selecionada ainda');
            }
            
            const opcoesDiv = document.getElementById('opcoes-entrega');
            let html = '';

            // Per√≠odo Comercial
            html += `
                <label class="flex items-start gap-4 p-4 rounded-lg hover:bg-text-dark/5 cursor-pointer transition-colors border-2 border-text-dark/10 hover:border-text-dark/20">
                    <input type="radio" name="tipo_entrega" value="comercial" class="mt-1 w-5 h-5 accent-text-dark" required>
                    <div class="flex-1">
                        <div class="font-semibold">Per√≠odo Comercial</div>
                        <div class="text-sm text-text-dark/60">8h30 √†s 18h00</div>
                        <div class="text-sm font-semibold text-green-600 mt-1">Gr√°tis</div>
                    </div>
                </label>
            `;

            // Per√≠odo Manh√£
            const podeManha = !isHoje || (isHoje && horaAtual < 10);
            html += `
                <label class="flex items-start gap-4 p-4 rounded-lg hover:bg-text-dark/5 cursor-pointer transition-colors border-2 border-text-dark/10 hover:border-text-dark/20 ${!podeManha ? 'opacity-50' : ''}">
                    <input type="radio" name="tipo_entrega" value="manha" class="mt-1 w-5 h-5 accent-text-dark" required ${!podeManha ? 'disabled' : ''}>
                    <div class="flex-1">
                        <div class="font-semibold">Per√≠odo Manh√£</div>
                        <div class="text-sm text-text-dark/60">8h30 √†s 13h00</div>
                        <div class="text-sm font-semibold mt-1">R$ 22,90</div>
                        ${!podeManha ? '<div class="text-xs text-red-600 mt-1">Dispon√≠vel apenas at√© 10h do dia da entrega</div>' : ''}
                    </div>
                </label>
            `;

            // Per√≠odo Tarde
            html += `
                <label class="flex items-start gap-4 p-4 rounded-lg hover:bg-text-dark/5 cursor-pointer transition-colors border-2 border-text-dark/10 hover:border-text-dark/20">
                    <input type="radio" name="tipo_entrega" value="tarde" class="mt-1 w-5 h-5 accent-text-dark" required>
                    <div class="flex-1">
                        <div class="font-semibold">Per√≠odo Tarde</div>
                        <div class="text-sm text-text-dark/60">13h √†s 19h</div>
                        <div class="text-sm font-semibold mt-1">R$ 22,90</div>
                    </div>
                </label>
            `;

            // Entrega Expressa (s√≥ aparece se for hoje)
            if (isHoje) {
                html += `
                    <label class="flex items-start gap-4 p-4 rounded-lg hover:bg-text-dark/5 cursor-pointer transition-colors border-2 border-text-dark/10 hover:border-text-dark/20">
                        <input type="radio" name="tipo_entrega" value="expressa" class="mt-1 w-5 h-5 accent-text-dark" required>
                        <div class="flex-1">
                            <div class="font-semibold">Entrega Expressa</div>
                            <div class="text-sm text-text-dark/60">Entrega em at√© horas ap√≥s a confirma√ß√£o do pagamento</div>
                            <div class="text-sm font-semibold mt-1">R$ 36,90</div>
                        </div>
                    </label>
                `;
            }

            opcoesDiv.innerHTML = html;

            // Adicionar listener para recalcular total quando mudar
            document.querySelectorAll('input[name="tipo_entrega"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    if (document.getElementById('step-confirmacao').classList.contains('active')) {
                        atualizarResumo();
                    }
                });
            });
        }

        function atualizarResumo() {
            const cart = getCart();

            // Resumo Endere√ßo
            const endereco = `${document.getElementById('rua').value}, ${document.getElementById('numero').value}${document.getElementById('complemento').value ? ' - ' + document.getElementById('complemento').value : ''} - ${document.getElementById('bairro').value}, ${document.getElementById('cidade').value} - ${document.getElementById('estado').value}`;
            document.getElementById('resumo-endereco').textContent = endereco;

            // Resumo Pessoal
            const pessoal = `<strong>${document.getElementById('nome_cliente').value}</strong><br>
            Telefone: ${document.getElementById('telefone').value}<br>
            CPF: ${document.getElementById('cpf').value}<br>
            Quem recebe: ${document.getElementById('nome_recebedor').value}`;
            document.getElementById('resumo-pessoal').innerHTML = pessoal;

            // Resumo Entrega
            const tipoEntrega = document.querySelector('input[name="tipo_entrega"]:checked');
            const tiposEntrega = {
                'comercial': 'Per√≠odo Comercial (8h30 √†s 18h00) - Gr√°tis',
                'manha': 'Per√≠odo Manh√£ (8h30 √†s 13h00) - R$ 22,90',
                'tarde': 'Per√≠odo Tarde (13h √†s 19h) - R$ 22,90',
                'expressa': 'Entrega Expressa (at√© 2h) - R$ 36,90'
            };
            const entrega = `Data: ${new Date(document.getElementById('data_entrega').value).toLocaleDateString('pt-BR')}<br>
            ${tipoEntrega ? tiposEntrega[tipoEntrega.value] : 'N√£o selecionado'}`;
            document.getElementById('resumo-entrega').innerHTML = entrega;

            // Resumo Carrinho
            let carrinhoHTML = '<div class="space-y-2">';
            const subtotal = cart.reduce((sum, item) => sum + (item.preco * (item.quantidade || 1)), 0);
            cart.forEach(item => {
                const total = (item.preco * (item.quantidade || 1)).toFixed(2);
                carrinhoHTML += `<div class="flex justify-between border-b border-text-dark/10 pb-2">
                    <span>${item.nome} <span class="text-xs text-text-dark/40">√ó${item.quantidade || 1}</span></span>
                    <span class="font-medium">R$ ${total}</span>
                </div>`;
            });
            carrinhoHTML += '</div>';
            document.getElementById('resumo-carrinho').innerHTML = carrinhoHTML;

            // Calcular total com frete
            const valorFrete = calcularValorEntrega();
            const total = (subtotal + valorFrete).toFixed(2);
            
            // Mostrar subtotal e frete
            let totalHTML = `<div class="text-right space-y-2 mb-2">
                <div class="text-sm text-text-dark/60">Subtotal: R$ ${subtotal.toFixed(2)}</div>
                <div class="text-sm text-text-dark/60">Entrega: R$ ${valorFrete.toFixed(2)}</div>
            </div>`;
            totalHTML += `<div class="text-right border-t border-text-dark/10 pt-2">
                <p class="font-serif text-2xl font-semibold">Total: R$ ${total}</p>
            </div>`;
            
            const totalDiv = document.getElementById('total-container');
            totalDiv.innerHTML = totalHTML;
        }

        async function confirmarPedido() {
            console.log('üöÄ Iniciando confirma√ß√£o de pedido...');
            
            const cart = getCart();
            console.log('üõí Carrinho:', cart);
            
            if (cart.length === 0) {
                alert('Seu carrinho est√° vazio!');
                return;
            }

            const botao = event.target;
            botao.disabled = true;
            botao.textContent = '‚è≥ Processando...';

            const tipoEntrega = document.querySelector('input[name="tipo_entrega"]:checked');
            const valorFrete = calcularValorEntrega();
            const subtotal = getCartTotal();
            const totalComFrete = subtotal + valorFrete;

            const dados = {
                nome_cliente: document.getElementById('nome_cliente').value,
                telefone: document.getElementById('telefone').value.replace(/\D/g, ''),
                cpf: document.getElementById('cpf').value.replace(/\D/g, ''),
                nome_recebedor: document.getElementById('nome_recebedor').value,
                cep: document.getElementById('cep').value.replace(/\D/g, ''),
                rua: document.getElementById('rua').value,
                numero: document.getElementById('numero').value,
                complemento: document.getElementById('complemento').value,
                bairro: document.getElementById('bairro').value,
                cidade: document.getElementById('cidade').value,
                estado: document.getElementById('estado').value,
                data_entrega: document.getElementById('data_entrega').value,
                tipo_entrega: tipoEntrega ? tipoEntrega.value : '',
                valor_frete: valorFrete,
                instrucoes_adicionais: document.getElementById('instrucoes_adicionais').value,
                mensagem_cartao: document.getElementById('mensagem_cartao').value,
                itens: cart,
                valor_total: totalComFrete
            };

            console.log('üì¶ Dados do pedido:', dados);

            try {
                // Chamar backend
                const BACKEND_URL = 'https://backendflori.vercel.app';
                console.log('üåê Chamando backend:', `${BACKEND_URL}/api/pedidos/criar`);
                
                const response = await fetch(`${BACKEND_URL}/api/pedidos/criar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                console.log('üì° Status da resposta:', response.status);
                
                const resultado = await response.json();
                console.log('‚úÖ Resposta do backend:', resultado);

                if (resultado.erro) {
                    console.error('‚ùå Erro retornado:', resultado.erro);
                    document.getElementById('confirmacao-erro').textContent = `‚ùå ${resultado.erro}`;
                    botao.disabled = false;
                    botao.textContent = 'Confirmar e Pagar';
                    return;
                }

                console.log('üí≥ Redirecionando para:', resultado.checkout_url);
                // Redirecionar para Mercado Pago
                window.location.href = resultado.checkout_url;

            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
                document.getElementById('confirmacao-erro').textContent = `‚ùå Erro ao processar pedido: ${error.message}`;
                botao.disabled = false;
                botao.textContent = 'Confirmar e Pagar';
            }
        }

        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
            // Verificar se tem carrinho
            if (getCart().length === 0) {
                alert('Seu carrinho est√° vazio! Adicione produtos antes de finalizar.');
                window.location.href = 'index.html';
                return;
            }

            // Mostrar passo 1
            proximaStep(1);

            // Configurar data m√≠nima (hoje)
            const dataInput = document.getElementById('data_entrega');
            const hoje = new Date();
            const hojeStr = hoje.toISOString().split('T')[0];
            dataInput.setAttribute('min', hojeStr);
            
            // Atualizar op√ß√µes de entrega quando mudar a data
            dataInput.addEventListener('change', () => {
                console.log('üìÖ Data alterada:', dataInput.value);
                atualizarOpcoesEntrega();
                if (document.getElementById('step-confirmacao').classList.contains('active')) {
                    atualizarResumo();
                }
            });

            // Inicializar op√ß√µes de entrega (sem data ainda)
            atualizarOpcoesEntrega();
            
            // Tamb√©m atualizar quando entrar no step 3
            const observer = new MutationObserver(() => {
                if (document.getElementById('step-entrega').classList.contains('active')) {
                    atualizarOpcoesEntrega();
                }
            });
            observer.observe(document.getElementById('step-entrega'), { attributes: true, attributeFilter: ['class'] });

            // M√°scara CEP
            document.getElementById('cep').addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 5) {
                    e.target.value = value;
                } else {
                    e.target.value = value.substring(0, 5) + '-' + value.substring(5, 8);
                }
            });

            // M√°scara Telefone
            document.getElementById('telefone').addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 10) {
                    e.target.value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
                } else {
                    e.target.value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
                }
            });

            // M√°scara CPF
            document.getElementById('cpf').addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                e.target.value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
            });
        });
    </script>
</body>
</html>
