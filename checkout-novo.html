<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - La Floricultura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-feature-settings: "pnum"; }
        input, textarea, select {
            background-color: transparent !important;
            border-bottom: 2px solid rgba(45, 45, 45, 0.15);
            transition: all 0.3s ease;
        }
        input:focus, textarea:focus, select:focus {
            border-bottom-color: #2D2D2D;
            outline: none;
        }
        .step-inactive { opacity: 0.5; }
        .step-active { opacity: 1; }
        .btn-primary {
            background: #8F4F3B;
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-primary:hover { background: #6d3d2c; }
        .error { color: #dc2626; font-size: 0.875rem; }
        .success { color: #16a34a; font-size: 0.875rem; }
        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body class="bg-white">
    <!-- Header -->
    <header class="border-b border-gray-200">
        <div class="container mx-auto px-4 py-4">
            <h1 class="font-serif text-3xl">Finalizar Pedido</h1>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Steps -->
        <div class="flex gap-4 mb-8">
            <div class="flex-1 text-center">
                <div class="inline-block w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold step-1">1</div>
                <p class="text-sm mt-2 step-1-label">Endere√ßo</p>
            </div>
            <div class="flex-1 text-center">
                <div class="inline-block w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold step-2 step-inactive">2</div>
                <p class="text-sm mt-2 step-2-label">Dados Pessoais</p>
            </div>
            <div class="flex-1 text-center">
                <div class="inline-block w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold step-3 step-inactive">3</div>
                <p class="text-sm mt-2 step-3-label">Entrega</p>
            </div>
            <div class="flex-1 text-center">
                <div class="inline-block w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold step-4 step-inactive">4</div>
                <p class="text-sm mt-2 step-4-label">Confirma√ß√£o</p>
            </div>
        </div>

        <!-- STEP 1: Endere√ßo -->
        <section id="step-endereco" class="section active">
            <div class="bg-gray-50 p-6 rounded-lg">
                <h2 class="font-serif text-2xl mb-4">Endere√ßo de Entrega</h2>
                
                <div class="mb-6">
                    <label class="font-sans font-semibold text-sm">CEP *</label>
                    <div class="flex gap-2">
                        <input type="text" id="cep" placeholder="00000-000" maxlength="9" class="flex-1 py-2" required>
                        <button type="button" onclick="buscarCEP()" class="btn-primary">Buscar</button>
                    </div>
                    <div id="cep-error" class="error mt-2"></div>
                    <div id="cep-success" class="success mt-2"></div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="font-sans font-semibold text-sm">Rua *</label>
                        <input type="text" id="rua" class="w-full py-2" readonly>
                    </div>
                    <div>
                        <label class="font-sans font-semibold text-sm">N√∫mero *</label>
                        <input type="text" id="numero" class="w-full py-2">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="font-sans font-semibold text-sm">Bairro *</label>
                        <input type="text" id="bairro" class="w-full py-2" readonly>
                    </div>
                    <div>
                        <label class="font-sans font-semibold text-sm">Cidade *</label>
                        <input type="text" id="cidade" class="w-full py-2" readonly>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="font-sans font-semibold text-sm">Estado *</label>
                        <input type="text" id="estado" class="w-full py-2" readonly>
                    </div>
                    <div>
                        <label class="font-sans font-semibold text-sm">Complemento (opcional)</label>
                        <input type="text" id="complemento" class="w-full py-2" placeholder="Apto 123, sala, etc">
                    </div>
                </div>

                <button type="button" onclick="proximaStep(2)" class="btn-primary w-full">Pr√≥ximo</button>
            </div>
        </section>

        <!-- STEP 2: Dados Pessoais -->
        <section id="step-pessoal" class="section">
            <div class="bg-gray-50 p-6 rounded-lg">
                <h2 class="font-serif text-2xl mb-4">Dados Pessoais</h2>
                
                <div class="mb-4">
                    <label class="font-sans font-semibold text-sm">Nome Completo *</label>
                    <input type="text" id="nome_cliente" class="w-full py-2" required>
                </div>

                <div class="mb-4">
                    <label class="font-sans font-semibold text-sm">Telefone *</label>
                    <input type="tel" id="telefone" placeholder="(21) 99999-9999" class="w-full py-2" required>
                </div>

                <div class="mb-4">
                    <label class="font-sans font-semibold text-sm">CPF *</label>
                    <input type="text" id="cpf" placeholder="000.000.000-00" class="w-full py-2" required>
                </div>

                <div class="mb-6">
                    <label class="font-sans font-semibold text-sm">Quem vai Receber? *</label>
                    <input type="text" id="nome_recebedor" placeholder="Nome da pessoa" class="w-full py-2" required>
                </div>

                <div class="flex gap-2">
                    <button type="button" onclick="proximaStep(1)" class="btn-primary flex-1" style="background: #999;">Voltar</button>
                    <button type="button" onclick="proximaStep(3)" class="btn-primary flex-1">Pr√≥ximo</button>
                </div>
            </div>
        </section>

        <!-- STEP 3: Entrega -->
        <section id="step-entrega" class="section">
            <div class="bg-gray-50 p-6 rounded-lg">
                <h2 class="font-serif text-2xl mb-4">Op√ß√µes de Entrega</h2>
                
                <div class="grid grid-cols-1 gap-4 mb-6">
                    <div>
                        <label class="font-sans font-semibold text-sm">Data de Entrega *</label>
                        <input type="date" id="data_entrega" class="w-full py-2" required>
                    </div>

                    <div>
                        <label class="font-sans font-semibold text-sm">Hor√°rio Preferencial *</label>
                        <select id="horario_entrega" class="w-full py-2" required>
                            <option value="">Selecione um hor√°rio</option>
                            <option value="08:00-12:00">08:00 √†s 12:00</option>
                            <option value="12:00-16:00">12:00 √†s 16:00</option>
                            <option value="16:00-20:00">16:00 √†s 20:00</option>
                        </select>
                    </div>

                    <div>
                        <label class="font-sans font-semibold text-sm">Instru√ß√µes Adicionais (opcional)</label>
                        <textarea id="instrucoes_adicionais" rows="3" class="w-full py-2 border-b-2" placeholder="Ex: deixe na portaria, avise antes, etc"></textarea>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button type="button" onclick="proximaStep(2)" class="btn-primary flex-1" style="background: #999;">Voltar</button>
                    <button type="button" onclick="proximaStep(4)" class="btn-primary flex-1">Pr√≥ximo</button>
                </div>
            </div>
        </section>

        <!-- STEP 4: Confirma√ß√£o -->
        <section id="step-confirmacao" class="section">
            <div class="bg-gray-50 p-6 rounded-lg">
                <h2 class="font-serif text-2xl mb-6">Confirma√ß√£o do Pedido</h2>
                
                <!-- Resumo Endere√ßo -->
                <div class="mb-6 pb-6 border-b">
                    <h3 class="font-serif text-lg font-semibold mb-2">Endere√ßo</h3>
                    <p id="resumo-endereco" class="text-sm text-gray-700"></p>
                </div>

                <!-- Resumo Pessoal -->
                <div class="mb-6 pb-6 border-b">
                    <h3 class="font-serif text-lg font-semibold mb-2">Dados Pessoais</h3>
                    <p id="resumo-pessoal" class="text-sm text-gray-700"></p>
                </div>

                <!-- Resumo Entrega -->
                <div class="mb-6 pb-6 border-b">
                    <h3 class="font-serif text-lg font-semibold mb-2">Entrega</h3>
                    <p id="resumo-entrega" class="text-sm text-gray-700"></p>
                </div>

                <!-- Resumo Carrinho -->
                <div class="mb-6 pb-6 border-b">
                    <h3 class="font-serif text-lg font-semibold mb-2">Produtos</h3>
                    <div id="resumo-carrinho" class="text-sm text-gray-700"></div>
                </div>

                <!-- Total -->
                <div class="mb-6 text-right">
                    <p class="font-serif text-2xl font-semibold">Total: <span id="total-valor">R$ 0,00</span></p>
                </div>

                <div id="confirmacao-erro" class="error mb-4"></div>

                <div class="flex gap-2">
                    <button type="button" onclick="proximaStep(3)" class="btn-primary flex-1" style="background: #999;">Voltar</button>
                    <button type="button" onclick="confirmarPedido()" class="btn-primary flex-1" style="background: #16a34a;">Confirmar e Pagar</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Inicializar Supabase
        const supabaseClient = window.supabase.createClient(
            'https://nrgwldtmucptrhoyqted.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yZ3dsZHRtdWNwdHJob3lxdGVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTkxMjAsImV4cCI6MjA4NTkzNTEyMH0.8PLX18bXir94kCS5epFEyFGGEHxwKC3YANvwLE1SjmI'
        );

        // Carrinho
        function getCart() {
            const cart = localStorage.getItem('lafloricultura_cart');
            return cart ? JSON.parse(cart) : [];
        }

        function getCartTotal() {
            return getCart().reduce((total, item) => total + (item.preco * (item.quantidade || 1)), 0);
        }

        // Valida√ß√£o de CEP - Grande Rio
        const CEPS_RIO = {
            '20000': { cidade: 'Rio de Janeiro', bairro: 'Centro', estado: 'RJ' },
            '20040': { cidade: 'Rio de Janeiro', bairro: 'Centro', estado: 'RJ' },
            '20260': { cidade: 'Rio de Janeiro', bairro: 'Lapa', estado: 'RJ' },
            '20530': { cidade: 'Rio de Janeiro', bairro: 'Santa Teresa', estado: 'RJ' },
            '20731': { cidade: 'Rio de Janeiro', bairro: 'Botafogo', estado: 'RJ' },
            '22040': { cidade: 'Rio de Janeiro', bairro: 'Copacabana', estado: 'RJ' },
            '22250': { cidade: 'Rio de Janeiro', bairro: 'Ipanema', estado: 'RJ' },
            '22451': { cidade: 'Rio de Janeiro', bairro: 'Leblon', estado: 'RJ' },
            '20750': { cidade: 'Rio de Janeiro', bairro: 'Urca', estado: 'RJ' },
            '20961': { cidade: 'Rio de Janeiro', bairro: 'Flamengo', estado: 'RJ' },
            '22080': { cidade: 'Rio de Janeiro', bairro: 'Humait√°', estado: 'RJ' },
            '21020': { cidade: 'Rio de Janeiro', bairro: 'Pra√ßa XV', estado: 'RJ' },
            // Niter√≥i
            '24020': { cidade: 'Niter√≥i', bairro: 'Centro', estado: 'RJ' },
            '24230': { cidade: 'Niter√≥i', bairro: 'Icara√≠', estado: 'RJ' },
            // S√£o Gon√ßalo
            '24450': { cidade: 'S√£o Gon√ßalo', bairro: 'Centro', estado: 'RJ' },
            // Duque de Caxias
            '25070': { cidade: 'Duque de Caxias', bairro: 'Centro', estado: 'RJ' },
            // Maric√°
            '24750': { cidade: 'Maric√°', bairro: 'Centro', estado: 'RJ' }
        };

        async function buscarCEP() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            const errorDiv = document.getElementById('cep-error');
            const successDiv = document.getElementById('cep-success');

            console.log('üîç Buscando CEP:', cep);

            errorDiv.textContent = '';
            successDiv.textContent = '';

            if (cep.length !== 8) {
                errorDiv.textContent = '‚ùå CEP deve ter 8 d√≠gitos';
                console.log('‚ùå CEP inv√°lido - menos de 8 d√≠gitos');
                return;
            }

            const prefixoCEP = cep.substring(0, 5);
            console.log('üìç Prefixo CEP:', prefixoCEP);
            console.log('üìã CEPs v√°lidos:', Object.keys(CEPS_RIO));

            const dadosCEP = CEPS_RIO[prefixoCEP];
            console.log('‚úÖ Dados do CEP encontrado:', dadosCEP);

            if (!dadosCEP) {
                errorDiv.textContent = '‚ùå S√≥ fazemos entrega na Grande Rio de Janeiro';
                console.log('‚ùå CEP fora da √°rea de entrega');
                return;
            }

            // Buscar dados de rua via ViaCEP
            try {
                console.log('üåê Consultando ViaCEP...');
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();

                console.log('üì¶ Resposta ViaCEP:', data);

                if (data.erro) {
                    errorDiv.textContent = '‚ùå CEP n√£o encontrado';
                    console.log('‚ùå ViaCEP retornou erro');
                    return;
                }

                document.getElementById('rua').value = data.logradouro;
                document.getElementById('bairro').value = data.bairro || dadosCEP.bairro;
                document.getElementById('cidade').value = dadosCEP.cidade;
                document.getElementById('estado').value = dadosCEP.estado;

                successDiv.textContent = '‚úÖ Endere√ßo validado! Voc√™ est√° na regi√£o de entrega';
                console.log('‚úÖ Endere√ßo preenchido com sucesso!');
            } catch (error) {
                errorDiv.textContent = '‚ùå Erro ao buscar CEP';
                console.error('‚ùå Erro na busca:', error);
            }
        }

        // Navega√ß√£o entre steps
        function proximaStep(numeroStep) {
            // Validar step anterior
            if (numeroStep === 2 && !validarStep1()) return;
            if (numeroStep === 3 && !validarStep2()) return;
            if (numeroStep === 4 && !validarStep3()) return;

            // Esconder todos
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Mostrar novo
            const stepMap = { 1: 'endereco', 2: 'pessoal', 3: 'entrega', 4: 'confirmacao' };
            document.getElementById(`step-${stepMap[numeroStep]}`).classList.add('active');

            // Atualizar steps visuais
            for (let i = 1; i <= 4; i++) {
                const step = document.querySelector(`.step-${i}`);
                if (i < numeroStep) {
                    step.classList.remove('step-inactive');
                    step.parentElement.style.opacity = '0.7';
                } else if (i === numeroStep) {
                    step.classList.remove('step-inactive');
                    step.parentElement.style.opacity = '1';
                } else {
                    step.classList.add('step-inactive');
                }
            }

            // Se chegou ao passo 4, atualizar resumo
            if (numeroStep === 4) {
                atualizarResumo();
            }

            window.scrollTo(0, 0);
        }

        function validarStep1() {
            const cep = document.getElementById('cep').value;
            const rua = document.getElementById('rua').value;
            const numero = document.getElementById('numero').value;
            const bairro = document.getElementById('bairro').value;
            const cidade = document.getElementById('cidade').value;

            if (!cep || !rua || !numero || !bairro || !cidade) {
                alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios');
                return false;
            }
            return true;
        }

        function validarStep2() {
            const nome = document.getElementById('nome_cliente').value;
            const telefone = document.getElementById('telefone').value;
            const cpf = document.getElementById('cpf').value;
            const recebedor = document.getElementById('nome_recebedor').value;

            if (!nome || !telefone || !cpf || !recebedor) {
                alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios');
                return false;
            }
            return true;
        }

        function validarStep3() {
            const data = document.getElementById('data_entrega').value;
            const horario = document.getElementById('horario_entrega').value;

            if (!data || !horario) {
                alert('‚ö†Ô∏è Selecione data e hor√°rio de entrega');
                return false;
            }
            return true;
        }

        function atualizarResumo() {
            const cart = getCart();

            // Resumo Endere√ßo
            const endereco = `${document.getElementById('rua').value}, ${document.getElementById('numero').value}${document.getElementById('complemento').value ? ' - ' + document.getElementById('complemento').value : ''} - ${document.getElementById('bairro').value}, ${document.getElementById('cidade').value} - ${document.getElementById('estado').value}`;
            document.getElementById('resumo-endereco').textContent = endereco;

            // Resumo Pessoal
            const pessoal = `<strong>${document.getElementById('nome_cliente').value}</strong><br>
            Telefone: ${document.getElementById('telefone').value}<br>
            CPF: ${document.getElementById('cpf').value}<br>
            Quem recebe: ${document.getElementById('nome_recebedor').value}`;
            document.getElementById('resumo-pessoal').innerHTML = pessoal;

            // Resumo Entrega
            const entrega = `Data: ${new Date(document.getElementById('data_entrega').value).toLocaleDateString('pt-BR')}<br>
            Hor√°rio: ${document.getElementById('horario_entrega').value}`;
            document.getElementById('resumo-entrega').innerHTML = entrega;

            // Resumo Carrinho
            let carrinhoHTML = '<table class="w-full"><tr><th class="text-left">Produto</th><th class="text-right">Qtd</th><th class="text-right">Total</th></tr>';
            cart.forEach(item => {
                const total = (item.preco * (item.quantidade || 1)).toFixed(2);
                carrinhoHTML += `<tr class="border-t"><td>${item.nome}</td><td class="text-right">${item.quantidade || 1}</td><td class="text-right">R$ ${total}</td></tr>`;
            });
            carrinhoHTML += '</table>';
            document.getElementById('resumo-carrinho').innerHTML = carrinhoHTML;

            // Total
            const total = getCartTotal().toFixed(2);
            document.getElementById('total-valor').textContent = `R$ ${total}`;
        }

        async function confirmarPedido() {
            console.log('üöÄ Iniciando confirma√ß√£o de pedido...');
            
            const cart = getCart();
            console.log('üõí Carrinho:', cart);
            
            if (cart.length === 0) {
                alert('Seu carrinho est√° vazio!');
                return;
            }

            const botao = event.target;
            botao.disabled = true;
            botao.textContent = '‚è≥ Processando...';

            const dados = {
                nome_cliente: document.getElementById('nome_cliente').value,
                telefone: document.getElementById('telefone').value.replace(/\D/g, ''),
                cpf: document.getElementById('cpf').value.replace(/\D/g, ''),
                nome_recebedor: document.getElementById('nome_recebedor').value,
                cep: document.getElementById('cep').value.replace(/\D/g, ''),
                rua: document.getElementById('rua').value,
                numero: document.getElementById('numero').value,
                complemento: document.getElementById('complemento').value,
                bairro: document.getElementById('bairro').value,
                cidade: document.getElementById('cidade').value,
                estado: document.getElementById('estado').value,
                data_entrega: document.getElementById('data_entrega').value,
                horario_entrega: document.getElementById('horario_entrega').value,
                instrucoes_adicionais: document.getElementById('instrucoes_adicionais').value,
                itens: cart,
                valor_total: getCartTotal()
            };

            console.log('üì¶ Dados do pedido:', dados);

            try {
                // Chamar backend
                const BACKEND_URL = 'http://localhost:3000'; // Mude para URL do seu backend em produ√ß√£o
                console.log('üåê Chamando backend:', `${BACKEND_URL}/api/pedidos/criar`);
                
                const response = await fetch(`${BACKEND_URL}/api/pedidos/criar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                console.log('üì° Status da resposta:', response.status);
                
                const resultado = await response.json();
                console.log('‚úÖ Resposta do backend:', resultado);

                if (resultado.erro) {
                    console.error('‚ùå Erro retornado:', resultado.erro);
                    document.getElementById('confirmacao-erro').textContent = `‚ùå ${resultado.erro}`;
                    botao.disabled = false;
                    botao.textContent = 'Confirmar e Pagar';
                    return;
                }

                console.log('üí≥ Redirecionando para:', resultado.checkout_url);
                // Redirecionar para Mercado Pago
                window.location.href = resultado.checkout_url;

            } catch (error) {
                console.error('‚ùå Erro na requisi√ß√£o:', error);
                document.getElementById('confirmacao-erro').textContent = `‚ùå Erro ao processar pedido: ${error.message}`;
                botao.disabled = false;
                botao.textContent = 'Confirmar e Pagar';
            }
        }

        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
            // Verificar se tem carrinho
            if (getCart().length === 0) {
                alert('Seu carrinho est√° vazio! Adicione produtos antes de finalizar.');
                window.location.href = '/index.html';
                return;
            }

            // Mostrar passo 1
            proximaStep(1);

            // M√°scara CEP
            document.getElementById('cep').addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 5) {
                    e.target.value = value;
                } else {
                    e.target.value = value.substring(0, 5) + '-' + value.substring(5, 8);
                }
            });

            // M√°scara Telefone
            document.getElementById('telefone').addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 10) {
                    e.target.value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
                } else {
                    e.target.value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
                }
            });

            // M√°scara CPF
            document.getElementById('cpf').addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                e.target.value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
            });
        });
    </script>
</body>
</html>
